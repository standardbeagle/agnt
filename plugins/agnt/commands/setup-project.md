---
description: "Configure scripts and proxies to auto-start when opening this project"
allowed-tools: ["mcp__agnt__detect", "Read", "Write", "AskUserQuestion"]
---

Configure project-level automation by creating a `.agnt.kdl` configuration file. The agnt plugin's SessionStart hook will read this file and auto-start your configured services.

## Steps

### 1. Detect Project Type

First, detect the project to find available scripts:

```
detect {path: "."}
```

### 2. Ask About Scripts to Auto-Start

Based on the detected scripts, use AskUserQuestion to ask:

**Question**: "Which scripts should auto-start when you open this project?"
- Present available scripts (dev, start, serve, watch, etc.)
- Allow multiple selections (multiSelect: true)
- Common choices: dev server, watch mode

### 3. Ask About Proxy Configuration

Use AskUserQuestion to ask:

**Question**: "Do you want to create debugging proxies for your scripts?"

If yes, ask:
- **Proxy ID**: A short name (e.g., "dev", "app")
- **Which script**: Which script to link the proxy to (usually the dev server)
- Note: Proxies will automatically start when the script outputs URLs

### 4. Write .agnt.kdl Configuration

Create or update `.agnt.kdl` in the project root with KDL format:

```kdl
// .agnt.kdl - agnt project configuration
// Auto-generated by /setup-project command

// Scripts to auto-start on session open
scripts {
    dev {
        auto-start true
        // URL matchers filter which URLs to create proxies for
        // Next.js outputs both Local and Network URLs - match both
        url-matchers "(Local|Network):\\s*{url}"
    }
}

// Proxy configuration - automatically created when script outputs URLs
proxies {
    dev {
        // Link to script - proxy will be created when URLs are detected
        script "dev"
    }
}

// For fully-specified proxies (explicit port/URL), use auto-start:
// proxies {
//     api {
//         port 8080
//         auto-start true
//     }
// }
```

### 5. Explain What Happens

After creating the config, inform the user:

1. **Starting your dev environment**: Run `agnt run claude` to start your AI coding session. This will:
   - Load your `.agnt.kdl` configuration
   - Auto-start all scripts with `autostart: true` in the background
   - Monitor script output for URLs
   - Automatically create proxies when URLs are detected from linked scripts
   - Display running services in the status bar at the bottom of your terminal

2. **Status bar information**: The bottom status bar shows:
   - Running processes count (e.g., "⚙ 2 proc")
   - Proxy URLs for browser access (e.g., "frontend:3000 → proxy:18080")
   - Use **CTRL+Y** to toggle the overlay menu for more options

3. **Overlay menu (CTRL+Y)**: Press CTRL+Y to access:
   - List of running processes and proxies
   - Quick actions (restart, stop, view output)
   - Browser access links
   - System status

4. **Port visibility for OAuth**: The status bar shows both your dev server port AND proxy port (e.g., "dev:3000 → proxy:18080"). Add BOTH to your OAuth redirect URLs:
   - Dev server: `http://localhost:3000`
   - Proxy: `http://localhost:18080` (for browser debugging)

5. **To modify**: Edit `.agnt.kdl` directly or re-run `/setup-project`

6. **To skip autostart**: Run `agnt run claude --no-autostart` to start without auto-starting configured services

7. **To restart a service**: Use the MCP tool `proc {action: "restart", process_id: "dev"}` or access via CTRL+Y menu

## Example Configuration

For a typical Next.js project:

```kdl
scripts {
    dev {
        auto-start true
        url-matchers "(Local|Network):\\s*{url}"
    }
}

proxies {
    dev {
        script "dev"
    }
}
```

For a project with multiple services:

```kdl
scripts {
    dev {
        auto-start true
        url-matchers "(Local|Network):\\s*{url}"
    }

    api {
        auto-start true
        url-matchers "listening on port {url}"
    }
}

proxies {
    frontend {
        script "dev"
    }

    backend {
        script "api"
    }
}
```

For a project with explicit proxy ports:

```kdl
scripts {
    dev auto-start=true
}

proxies {
    api {
        port 8080
        auto-start true
    }
}
```
