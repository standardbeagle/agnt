---
description: "Configure scripts and proxies to auto-start when opening this project"
allowed-tools: ["mcp__agnt__detect", "Read", "Write", "AskUserQuestion"]
---

Configure project-level automation by creating a `.agnt.kdl` configuration file. The agnt plugin's SessionStart hook will read this file and auto-start your configured services.

## Steps

### 1. Detect Project Type

First, detect the project to find available scripts:

```
detect {path: "."}
```

### 2. Ask About Scripts to Auto-Start

Based on the detected scripts, use AskUserQuestion to ask:

**Question**: "Which scripts should auto-start when you open this project?"
- Present available scripts (dev, start, serve, watch, etc.)
- Allow multiple selections (multiSelect: true)
- Common choices: dev server, watch mode

### 3. Ask About Proxy Configuration

Use AskUserQuestion to ask:

**Question**: "Do you want to create debugging proxies for your scripts?"

If yes, ask:
- **Proxy ID**: A short name (e.g., "dev", "app")
- **Which script**: Which script to link the proxy to (usually the dev server)
- Note: Proxies will automatically start when the script outputs URLs

### 4. Ask About Browser Notifications

Use AskUserQuestion to ask:

**Question**: "Do you want browser notifications when your AI agent responds?"

Options:
- **Toast notifications**: Show popup messages in the browser
- **Indicator flash**: Flash the floating bug indicator
- **Sound alerts**: Play notification sounds (requires browser permission)

### 5. Write .agnt.kdl Configuration

Create or update `.agnt.kdl` in the project root with KDL format:

```kdl
// .agnt.kdl - agnt project configuration
// Auto-generated by /setup-project command

// Scripts to auto-start on session open
scripts {
    dev {
        autostart true
        // URL matchers filter which URLs to create proxies for
        // Next.js outputs both Local and Network URLs - match both
        url-matchers "(Local|Network):\\s*{url}"
    }
}

// Proxy configuration - automatically created when script outputs URLs
proxies {
    dev {
        // Link to script - proxy will be created when URLs are detected
        script "dev"
    }
}

// Hook configuration for browser notifications
hooks {
    on-response {
        toast true      // Show toast notification in browser
        indicator true  // Flash the bug indicator
        sound false     // Play notification sound
    }
}

// Toast notification settings
toast {
    duration 4000           // Duration in ms
    position "bottom-right" // top-right, top-left, bottom-right, bottom-left
    max-visible 3           // Max simultaneous toasts
}

// For fully-specified proxies (explicit port/URL), use autostart:
// proxies {
//     api {
//         port 8080
//         autostart true
//     }
// }
```

### 6. Explain What Happens

After creating the config, inform the user:

1. **Starting your dev environment**: Run `agnt run claude` to start your AI coding session. This will:
   - Load your `.agnt.kdl` configuration
   - Auto-start all scripts with `autostart: true` in the background
   - Monitor script output for URLs
   - Automatically create proxies when URLs are detected from linked scripts
   - Display running services in the status bar at the bottom of your terminal

2. **Status bar information**: The bottom status bar shows:
   - Running processes count (e.g., "⚙ 2 proc")
   - Proxy URLs for browser access (e.g., "frontend:3000 → proxy:18080")
   - Use **CTRL+Y** to toggle the overlay menu for more options

3. **Overlay menu (CTRL+Y)**: Press CTRL+Y to access:
   - List of running processes and proxies
   - Quick actions (restart, stop, view output)
   - Browser access links
   - System status

4. **Port visibility for OAuth**: The status bar shows both your dev server port AND proxy port (e.g., "dev:3000 → proxy:18080"). Add BOTH to your OAuth redirect URLs:
   - Dev server: `http://localhost:3000`
   - Proxy: `http://localhost:18080` (for browser debugging)

5. **To modify**: Edit `.agnt.kdl` directly or re-run `/setup-project`

6. **To skip autostart**: Run `agnt run claude --no-autostart` to start without auto-starting configured services

7. **To restart a service**: Use the MCP tool `proc {action: "restart", process_id: "dev"}` or access via CTRL+Y menu

## Example Configurations

### Next.js Project

```kdl
scripts {
    dev {
        autostart true
        url-matchers "(Local|Network):\\s*{url}"
    }
}

proxies {
    dev {
        script "dev"
    }
}

hooks {
    on-response {
        toast true
        indicator true
    }
}
```

### Multiple Services (Frontend + API)

```kdl
scripts {
    dev {
        run "npm run dev"
        autostart true
        url-matchers "(Local|Network):\\s*{url}"
    }

    api {
        command "go"
        args "run" "./cmd/server"
        autostart true
        env {
            GIN_MODE "debug"
        }
    }
}

proxies {
    frontend {
        script "dev"
    }

    backend {
        target "http://localhost:8080"
        autostart true
        max-log-size 2000
    }
}
```

### Explicit Proxy Ports

```kdl
scripts {
    dev {
        run "npm run dev"
        autostart true
    }
}

proxies {
    api {
        port 8080
        autostart true
    }
}

toast {
    duration 5000
    position "top-right"
}
```

### Python Development

```kdl
scripts {
    serve {
        run "python3 -m http.server 9500"
        autostart true
    }

    flask {
        command "flask"
        args "run" "--debug"
        autostart true
        env {
            FLASK_APP "app.py"
            FLASK_ENV "development"
        }
        cwd "./backend"
    }
}

proxies {
    app {
        target "http://localhost:5000"
        autostart true
    }
}
```

### Wails (Go Desktop App)

```kdl
scripts {
    dev {
        run "wails dev"
        autostart true
        // Wails outputs: "Using DevServer URL: http://localhost:34115"
        url-matchers "DevServer URL:\\s*{url}"
    }
}

proxies {
    app {
        script "dev"
    }
}

hooks {
    on-response {
        toast true
        indicator true
    }
}
```

### Astro

```kdl
scripts {
    dev {
        run "npm run dev"
        autostart true
        // Astro outputs: "┃ Local    http://localhost:4321/"
        url-matchers "Local\\s+{url}"
    }
}

proxies {
    site {
        script "dev"
    }
}
```

### Jekyll

```kdl
scripts {
    serve {
        run "bundle exec jekyll serve"
        autostart true
        // Jekyll outputs: "Server address: http://127.0.0.1:4000/"
        url-matchers "Server address:\\s*{url}"
    }
}

proxies {
    docs {
        script "serve"
    }
}
```
