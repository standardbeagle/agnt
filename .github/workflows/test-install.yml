name: Test Install

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (leave empty for latest)'
        required: false
        type: string

jobs:
  test-go:
    name: go install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install via go install
        run: go install github.com/standardbeagle/agnt/cmd/agnt@${{ inputs.version && format('v{0}', inputs.version) || 'latest' }}

      - name: Verify version
        run: agnt --version

      - name: Test serve --help
        run: agnt serve --help

  test-npm:
    name: npm (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install via npm
        run: npm install -g @standardbeagle/agnt${{ inputs.version && format('@{0}', inputs.version) || '' }}

      - name: Debug npm paths
        shell: bash
        run: |
          echo "npm bin: $(npm bin -g)"
          echo "PATH: $PATH"
          ls -la "$(npm bin -g)" || true

      - name: Verify version
        shell: bash
        run: |
          export PATH="$(npm bin -g):$PATH"
          agnt --version

      - name: Test serve --help
        shell: bash
        run: |
          export PATH="$(npm bin -g):$PATH"
          agnt serve --help

  test-pip:
    name: pip (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install via pip
        run: pip install agnt${{ inputs.version && format('=={0}', inputs.version) || '' }}

      - name: Verify version
        run: agnt --version

      - name: Test daemon status (Unix)
        if: runner.os != 'Windows'
        run: agnt daemon status || echo "Daemon not running (expected)"

      - name: Test daemon status (Windows)
        if: runner.os == 'Windows'
        run: |
          agnt daemon status
          if ($LASTEXITCODE -ne 0) { Write-Host "Daemon not running (expected)" }
        shell: pwsh

      - name: Test serve --help
        run: agnt serve --help

  test-uv:
    name: uv (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install via uv tool
        run: uv tool install agnt${{ inputs.version && format('=={0}', inputs.version) || '' }}

      - name: Verify version
        run: agnt --version

      - name: Test daemon status (Unix)
        if: runner.os != 'Windows'
        run: agnt daemon status || echo "Daemon not running (expected)"

      - name: Test daemon status (Windows)
        if: runner.os == 'Windows'
        run: |
          agnt daemon status
          if ($LASTEXITCODE -ne 0) { Write-Host "Daemon not running (expected)" }
        shell: pwsh

      - name: Test serve --help
        run: agnt serve --help

  test-npx:
    name: npx (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test via npx (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # npx runs postinstall which downloads binary, then we need to find it
          npx --yes @standardbeagle/agnt${{ inputs.version && format('@{0}', inputs.version) || '' }} --version || echo "npx test - may need PATH fix"

      - name: Test via npx (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          npx --yes @standardbeagle/agnt${{ inputs.version && format('@{0}', inputs.version) || '' }} --version
          if ($LASTEXITCODE -ne 0) { Write-Host "npx test - may need PATH fix" }

  test-uvx:
    name: uvx (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Test via uvx
        run: uvx agnt${{ inputs.version && format('=={0}', inputs.version) || '' }} --version

  test-curl-install:
    name: curl install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install via curl
        run: |
          curl -fsSL https://raw.githubusercontent.com/standardbeagle/agnt/main/install.sh | bash

      - name: Verify version
        run: ~/.local/bin/agnt --version

  test-powershell-install:
    name: PowerShell install
    runs-on: windows-latest
    steps:
      - name: Install via PowerShell
        shell: pwsh
        run: |
          irm https://raw.githubusercontent.com/standardbeagle/agnt/main/install.ps1 | iex

      - name: Verify version
        shell: pwsh
        run: |
          $env:PATH = "$env:LOCALAPPDATA\agnt;$env:PATH"
          agnt --version

  test-docker:
    name: Docker (${{ matrix.image }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: ubuntu:22.04
            install: apt-get update && apt-get install -y npm && npm install -g @standardbeagle/agnt
          - image: debian:12
            install: apt-get update && apt-get install -y npm && npm install -g @standardbeagle/agnt
          - image: python:3.12-slim
            install: pip install agnt
    runs-on: ubuntu-latest
    container: ${{ matrix.image }}
    steps:
      - name: Install agnt
        run: ${{ matrix.install }}

      - name: Verify version
        run: agnt --version

      - name: Test serve --help
        run: agnt serve --help
