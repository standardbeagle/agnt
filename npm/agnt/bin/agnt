#!/usr/bin/env node

/**
 * agnt wrapper script
 *
 * This script is the entry point that npm symlinks to.
 * It handles binary updates/cleanup and executes the downloaded Go binary.
 *
 * Update mechanism (Windows-compatible):
 * - .old files: Previous binary, renamed during update (cleanup on next run)
 * - .new files: Pending update, applied on next run
 *
 * This allows updates even when the daemon is running (Windows locks executables).
 */

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

// Binary is downloaded to bin/agnt-binary (or agnt-binary.exe on Windows)
const BINARY_NAME = process.platform === 'win32' ? 'agnt-binary.exe' : 'agnt-binary';
const binDir = __dirname;
const binaryPath = path.join(binDir, BINARY_NAME);
const oldPath = binaryPath + '.old';
const newPath = binaryPath + '.new';

// Cleanup old binary from previous update (may fail if still locked, that's ok)
try {
  if (fs.existsSync(oldPath)) {
    fs.unlinkSync(oldPath);
  }
} catch (e) {
  // Ignore - file may still be locked by running daemon
}

// Apply pending update if exists
if (fs.existsSync(newPath)) {
  try {
    // Rename current to .old (works even if running on Windows)
    if (fs.existsSync(binaryPath)) {
      fs.renameSync(binaryPath, oldPath);
    }
    // Move new binary into place
    fs.renameSync(newPath, binaryPath);
    console.error('Updated to new version');
    // Try to cleanup old
    try {
      fs.unlinkSync(oldPath);
    } catch (e) {
      // Ignore - will cleanup next time
    }
  } catch (e) {
    console.error(`Warning: Failed to apply pending update: ${e.message}`);
  }
}

// Check if binary exists
if (!fs.existsSync(binaryPath)) {
  console.error(`Error: agnt binary not found at ${binaryPath}`);
  console.error('');
  console.error('The binary may not have been downloaded during installation.');
  console.error('Try reinstalling the package:');
  console.error('  npm uninstall -g @standardbeagle/agnt');
  console.error('  npm install -g @standardbeagle/agnt');
  console.error('');
  console.error('Or manually run the postinstall script:');
  console.error('  node ' + path.join(binDir, '..', 'scripts', 'install.js'));
  process.exit(1);
}

// Execute the binary with all arguments
const child = spawn(binaryPath, process.argv.slice(2), {
  stdio: 'inherit',
  windowsHide: true,
});

child.on('error', (err) => {
  console.error(`Error executing agnt: ${err.message}`);
  process.exit(1);
});

child.on('close', (code) => {
  process.exit(code || 0);
});
